<?xml version="1.0" encoding="utf-8"?>
<torgtaitai:CommonPopupWindow
   xmlns:mx="http://www.adobe.com/2006/mxml"
   xmlns:torgtaitai="*" 
   width="380"
   height="235"
   title="カウンターリモコンエディター" 
   showCloseButton="true"
   >
  
  <mx:Box width="100%" height="100%">
    <mx:Form
      width="100%"
       paddingTop="1" paddingBottom="1" 
       paddingRight="1" paddingLeft="1" >
      
	  <mx:FormItem label="ボタン名:" width="100%" >
      <mx:TextInput id="labelName" height="25" width="100%" text="HP増加" />
      </mx:FormItem>
      
	  <mx:FormItem label="カウンター名\{1\}:" width="100%" >
        <mx:TextInput id="counterName" height="25" width="100%" text="HP" toolTip="イニシアティブは「#INI」で指定できます。"  change="printSampleMessage()" />
      </mx:FormItem>
      
	  <mx:FormItem label="修正値\{2\}:" width="100%" >
        <mx:HBox width="100%" height="25">
          <mx:ComboBox id="operator" toolTip="現状値に加減算するか、値を差し替えるかを選択できます。" change="printSampleMessage()" >
            <mx:Array>
              <mx:Object label="＋" data="plus" />
              <mx:Object label="−" data="minus" />
              <mx:Object label="＝" data="equal" />
            </mx:Array>
          </mx:ComboBox>
          
          <mx:TextInput id="modifyValue" height="25" width="100%" text="1" toolTip="設定可能な書式&#13; （空）　：任意の値を後から指定&#13; 数値　：指定した値&#13; 「xDy+n」形式：ダイスロール結果（例：２ｄ６＋１）" change="printSampleMessage()" />
        </mx:HBox>
      </mx:FormItem>
      
	  <mx:FormItem label="表示メッセージ:" width="100%" >
        <mx:TextInput id="messageFormat" height="25" width="100%" text="\{0\}の\{1\}を\{2\}した"
                      change="printSampleMessage()"
                      toolTip="使用可能な置換文字：&#13;\{0\}：キャラクター名&#13;\{1\}：カウンター名&#13;\{2\}：修正値&#13;\{3\}：修正値絶対値（＋−無し）&#13;\{4\}：変更結果"
                      />
      </mx:FormItem>
      
	  <mx:FormItem label="例:" width="100%" >
        <mx:Label id="sampleMessage" height="25" width="100%" />
      </mx:FormItem>
      
    </mx:Form>
    
    <mx:HBox height="25" width="100%" horizontalAlign="center" verticalAlign="middle">
      <mx:Button id="executeButton" label="設定" click="execute()" />
      <mx:Button label="キャンセル" click="PopUpManager.removePopUp(this)" />
    </mx:HBox>
  </mx:Box>
  
  <mx:Script>
    <![CDATA[

    import mx.containers.TitleWindow;
    import mx.managers.PopUpManager;
    import mx.utils.StringUtil;
    
    private var index:int = -1;
    
    public function setParams(params:Object, index_:int):void {
        this.index = index_;
        
        if( params == null ) {
            operator.selectedIndex = 0;
            return;
        }
        
        labelName.text = params.label;
        
        Utils.selectComboBox(operator, params.operator, "data");
        modifyValue.text = params.modifyValue;
        counterName.text = params.counterName;
        messageFormat.text = params.messageFormat;
        
        printSampleMessage();
    }
    
    override protected function setup():void {
        printSampleMessage();
    }
    
    
    public function execute():void {
        var params:Object = new Object();
        params.label = labelName.text;
        params.operator = operator.selectedItem.data;
        params.modifyValue = getModifyValue();
        params.counterName = counterName.text;
        params.messageFormat = getMessageFormat();
        
        CounterRemocon.getInstance().changeButtonInfo(params, index);
        
        PopUpManager.removePopUp(this);
    }
    
    private function getModifyValue():String { 
        return Utils.changeZenkakuToHankaku( modifyValue.text );
    }
    
    private function getMessageFormat():String {
        var text:String = messageFormat.text;
        text = Utils.changeZenkakuToHankakuOnNumber(text);
        return text.replace(/｛(\d+)｝/g, "{$1}");
    }
    
    private function printSampleMessage():void {
        var format:String = getMessageFormat();
        var name:String = ChatWindow.getInstance().getChatCharacterName();
        var counter:String = counterName.text;
        
        var initValue:int = 0;
        var before:String = "" + initValue;
        
        var modifyResult:Object = 
        CounterRemocon.getInstance().getModifiedValue(initValue,
                                                      getModifyValue(),
                                                      operator.selectedItem.data);
        
        sampleMessage.text = CounterRemocon.getExecuteResultMessage(format, name, counter, before, modifyResult);
    }
    
    ]]>
  </mx:Script>
</torgtaitai:CommonPopupWindow>
